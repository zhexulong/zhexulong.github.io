{"componentChunkName":"component---src-templates-blog-post-js","path":"/rk3588/","result":{"data":{"site":{"siteMetadata":{"title":"且听龙吟"}},"markdownRemark":{"id":"a6873150-1878-5adc-9253-c43f8616d630","excerpt":"pipeline搭建 基于UNet的医学图像分割\n下面是分类结果,这是一个多标签分类的任务,所提供的为原始image和ground truth,prediction为网络预测的\n  观察到所提供的ground truth为灰度图像,首先要做的便是由灰度图像转为独热编码 然后,使用UNet训练(UNet与pytorch…","html":"<h2 id=\"pipeline搭建\" style=\"position:relative;\">pipeline搭建<a href=\"#pipeline%E6%90%AD%E5%BB%BA\" aria-label=\"pipeline搭建 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>基于UNet的医学图像分割\n下面是分类结果,这是一个多标签分类的任务,所提供的为原始image和ground truth,prediction为网络预测的\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/899269e00ab41251ca66f4b8154cce8b/34e70/img_1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.58227848101266%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAABC0lEQVR42j2PLcuDYBSGH4uyYhLLimBT0OTH0CAszG+TTBiiQRZMgmxs+xWL4n7UimCw6NowDdcMvgdeWLk598V1OBxUVdX1er1cLnme13X9/X6XZXk8HofDIcuyJElAmKYJIAxRFB2PxziO7/f7PM/INE0Mw9brNUJot9u932/wgiCAiuM45Ha7/Yee5/2gruufzweFYUhRFMuyJElaltX3PXi+769Wq6IowDMM4/V6AXRdlyCI2+0GUFXVcRyRbdtQaJqG1DTt+Xz+jjAMAylJUtM0AB3HgcrzPCTHccMwoLIsYQduggRPtm0L3vl8FkVxs9nIspymadd1AE+nkyAIiqIA3O/3fd//AfcafJnkGCwDAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_1.png\"\n        title=\"\"\n        src=\"/static/899269e00ab41251ca66f4b8154cce8b/f058b/img_1.png\"\n        srcset=\"/static/899269e00ab41251ca66f4b8154cce8b/c26ae/img_1.png 158w,\n/static/899269e00ab41251ca66f4b8154cce8b/6bdcf/img_1.png 315w,\n/static/899269e00ab41251ca66f4b8154cce8b/f058b/img_1.png 630w,\n/static/899269e00ab41251ca66f4b8154cce8b/40601/img_1.png 945w,\n/static/899269e00ab41251ca66f4b8154cce8b/34e70/img_1.png 1053w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 489px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b8fd4417d43efda804b9c9c50317ae91/03e1f/img_2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.53164556962025%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACP0lEQVR42lWRz0/TYBjHn62s69a3XdttECMhGhODETExCnGFtW7L2DrabV3ZwMSDxkszNXIQMLCNg4aDemKSDUmIVxVdiGcPcuTAyb9A4tgyEo5y2PRdl2B8D0+evN/v5/nxvtDpdFqto3r9Z7P5q14/bLUaJyet09Pff6zTbrex2mgcNpt1LFnx6Pi4iRMswdxcKZ1eMIznudxKMvlM15ey2ZVMZnlt7T2Gd3a+Kcq8YSzNzhZzuYKuL6ZSC9nsciz2dHv7KwCM2mwyw6R9vpzLpdpskt0eBLgmSQ8wXCiUAUYIIsJxBs8bTqcCECQICeCqab4Akox4PKqHnRYE3d8/4/frgpACkEOhJxheXd0CuMNxGsepgjfTP5D1etOCkAQQ8/nXuHMQoQTLJhETdtOy26VYsCjLjzBcLL4DCODqDKMxtEw5QwipPK8BjJvmKwxLnEfz+HT14pB2eZBwR5Fb+R8WeQEvpc6cG5g8P2wjoyzChrEeHGSYBEnGblyfEBfz7Mh9RE4B3Jblx2cwy05Tzql0dPReQRYGky5nDOBWD56kUYLqi5AX7lKReZyTjgieqte5UOiOzbCJPnt0SFQvhaYpMu5whM9gCSHFTcc5pPBUzJoCa4FwuPtgpdJWtzOToFGcoVSG0mg6bhnG8/k3va8K4BIAE3gFvAxBjOGfkKSHVue3AFcIoieJluemZRg2zZewsfGpWq1tbtaq1S+VymcccV4uf9zd/Y7h/f0f6+sfLLVWqfwz4Mu9vYO/4vzfMdP7IeUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img_2.png\"\n        title=\"\"\n        src=\"/static/b8fd4417d43efda804b9c9c50317ae91/03e1f/img_2.png\"\n        srcset=\"/static/b8fd4417d43efda804b9c9c50317ae91/c26ae/img_2.png 158w,\n/static/b8fd4417d43efda804b9c9c50317ae91/6bdcf/img_2.png 315w,\n/static/b8fd4417d43efda804b9c9c50317ae91/03e1f/img_2.png 489w\"\n        sizes=\"(max-width: 489px) 100vw, 489px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3 id=\"观察到所提供的ground-truth为灰度图像首先要做的便是由灰度图像转为独热编码\" style=\"position:relative;\">观察到所提供的ground truth为灰度图像,首先要做的便是由灰度图像转为独热编码<a href=\"#%E8%A7%82%E5%AF%9F%E5%88%B0%E6%89%80%E6%8F%90%E4%BE%9B%E7%9A%84ground-truth%E4%B8%BA%E7%81%B0%E5%BA%A6%E5%9B%BE%E5%83%8F%E9%A6%96%E5%85%88%E8%A6%81%E5%81%9A%E7%9A%84%E4%BE%BF%E6%98%AF%E7%94%B1%E7%81%B0%E5%BA%A6%E5%9B%BE%E5%83%8F%E8%BD%AC%E4%B8%BA%E7%8B%AC%E7%83%AD%E7%BC%96%E7%A0%81\" aria-label=\"观察到所提供的ground truth为灰度图像首先要做的便是由灰度图像转为独热编码 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">def</span> <span class=\"token function\">convert_to_multi_labels</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    device <span class=\"token operator\">=</span> label<span class=\"token punctuation\">.</span>device\n    B<span class=\"token punctuation\">,</span> C<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W <span class=\"token operator\">=</span> label<span class=\"token punctuation\">.</span>shape\n    new_tensor <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>device<span class=\"token punctuation\">)</span>\n    mask1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>label <span class=\"token operator\">>=</span> <span class=\"token number\">255</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>squeeze<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    mask2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>label <span class=\"token operator\">>=</span> <span class=\"token number\">170</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>label <span class=\"token operator\">&lt;</span> <span class=\"token number\">255</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>squeeze<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    mask3 <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>label <span class=\"token operator\">>=</span> <span class=\"token number\">85</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;</span> <span class=\"token punctuation\">(</span>label <span class=\"token operator\">&lt;</span> <span class=\"token number\">170</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>squeeze<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    one <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>ones<span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>device<span class=\"token punctuation\">)</span>\n    zero <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span>size<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">,</span> H<span class=\"token punctuation\">,</span> W<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> device<span class=\"token operator\">=</span>device<span class=\"token punctuation\">)</span>\n    new_tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>mask1<span class=\"token punctuation\">,</span> one<span class=\"token punctuation\">,</span> zero<span class=\"token punctuation\">)</span>\n    new_tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>mask2<span class=\"token punctuation\">,</span> one<span class=\"token punctuation\">,</span> zero<span class=\"token punctuation\">)</span>\n    new_tensor<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>mask3<span class=\"token punctuation\">,</span> one<span class=\"token punctuation\">,</span> zero<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> new_tensor</code></pre></div>\n<h3 id=\"然后使用UNet训练UNet与pytorch所提供UNet源码基本一致在此略过\" style=\"position:relative;\">然后,使用UNet训练(UNet与pytorch所提供UNet源码基本一致,在此略过)<a href=\"#%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8UNet%E8%AE%AD%E7%BB%83UNet%E4%B8%8Epytorch%E6%89%80%E6%8F%90%E4%BE%9BUNet%E6%BA%90%E7%A0%81%E5%9F%BA%E6%9C%AC%E4%B8%80%E8%87%B4%E5%9C%A8%E6%AD%A4%E7%95%A5%E8%BF%87\" aria-label=\"然后使用UNet训练UNet与pytorch所提供UNet源码基本一致在此略过 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>loss使用BCE loss</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">MyBinaryCrossEntropy</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">object</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>sigmoid <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>bce <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>BCELoss<span class=\"token punctuation\">(</span>reduction<span class=\"token operator\">=</span><span class=\"token string\">'mean'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__call__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> pred_seg<span class=\"token punctuation\">,</span> seg_gt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        pred_seg_probs <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span>pred_seg<span class=\"token punctuation\">)</span>\n        seg_gt_probs <span class=\"token operator\">=</span> convert_to_multi_labels<span class=\"token punctuation\">(</span>seg_gt<span class=\"token punctuation\">)</span>\n        loss <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>bce<span class=\"token punctuation\">(</span>pred_seg_probs<span class=\"token punctuation\">,</span> seg_gt_probs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> loss</code></pre></div>\n<h3 id=\"最后不要忘了保存为pth模型onnx模型更佳\" style=\"position:relative;\">最后,不要忘了保存为pth模型(onnx模型更佳)<a href=\"#%E6%9C%80%E5%90%8E%E4%B8%8D%E8%A6%81%E5%BF%98%E4%BA%86%E4%BF%9D%E5%AD%98%E4%B8%BApth%E6%A8%A1%E5%9E%8Bonnx%E6%A8%A1%E5%9E%8B%E6%9B%B4%E4%BD%B3\" aria-label=\"最后不要忘了保存为pth模型onnx模型更佳 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">torch<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">.</span>state_dict<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> save_path<span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"rk3588板端推理部署\" style=\"position:relative;\">rk3588板端推理部署<a href=\"#rk3588%E6%9D%BF%E7%AB%AF%E6%8E%A8%E7%90%86%E9%83%A8%E7%BD%B2\" aria-label=\"rk3588板端推理部署 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>首先WSL配好rknn-toolkit2环境\n(坑点:使用百度源)</p>\n<h3 id=\"如果前面保存的模型为pth模型那么首先需要转换为onnx模型\" style=\"position:relative;\">如果前面保存的模型为pth模型,那么首先需要转换为onnx模型<a href=\"#%E5%A6%82%E6%9E%9C%E5%89%8D%E9%9D%A2%E4%BF%9D%E5%AD%98%E7%9A%84%E6%A8%A1%E5%9E%8B%E4%B8%BApth%E6%A8%A1%E5%9E%8B%E9%82%A3%E4%B9%88%E9%A6%96%E5%85%88%E9%9C%80%E8%A6%81%E8%BD%AC%E6%8D%A2%E4%B8%BAonnx%E6%A8%A1%E5%9E%8B\" aria-label=\"如果前面保存的模型为pth模型那么首先需要转换为onnx模型 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">from</span> torch <span class=\"token keyword\">import</span> nn\n<span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>functional <span class=\"token keyword\">as</span> F\nmodel_path<span class=\"token operator\">=</span><span class=\"token string\">'./model_bce.pth'</span> <span class=\"token comment\">#模型路径</span>\nmodel<span class=\"token operator\">=</span>UNet<span class=\"token punctuation\">(</span>n_channels<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> n_classes<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> C_base<span class=\"token operator\">=</span><span class=\"token number\">32</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#模型初始化</span>\ndevice <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>device<span class=\"token punctuation\">(</span><span class=\"token string\">'cpu'</span><span class=\"token punctuation\">)</span>\nmodel<span class=\"token punctuation\">.</span>load_state_dict<span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>model_path<span class=\"token punctuation\">,</span>map_location<span class=\"token operator\">=</span>device<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>strict<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#模型加载</span>\nnet<span class=\"token operator\">=</span>model<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nexample<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#给定输入</span>\ntorch<span class=\"token punctuation\">.</span>onnx<span class=\"token punctuation\">.</span>export<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span>example<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span><span class=\"token string\">'./UNet.onnx'</span><span class=\"token punctuation\">,</span>verbose<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> opset_version<span class=\"token operator\">=</span><span class=\"token number\">17</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">#导出</span></code></pre></div>\n<p>最后的opset_version最好是19,UNet的参数要与训练时参数一致,输入要与训练时输入一致</p>\n<h3 id=\"再将onnx模型转化为rknn模型\" style=\"position:relative;\">再将onnx模型转化为rknn模型<a href=\"#%E5%86%8D%E5%B0%86onnx%E6%A8%A1%E5%9E%8B%E8%BD%AC%E5%8C%96%E4%B8%BArknn%E6%A8%A1%E5%9E%8B\" aria-label=\"再将onnx模型转化为rknn模型 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\">## 测试用来构建RKNN模型的API</span>\n\n<span class=\"token keyword\">from</span> rknn<span class=\"token punctuation\">.</span>api <span class=\"token keyword\">import</span> RKNN\n\n<span class=\"token keyword\">if</span> __name__<span class=\"token operator\">==</span><span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    rknn <span class=\"token operator\">=</span> RKNN<span class=\"token punctuation\">(</span>verbose<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>verbose_file<span class=\"token operator\">=</span><span class=\"token string\">\"log.txt\"</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\"># verbose为True表示打印详细的日志，verbose_file表示将日志存放到指定的路径中</span>\n\n    <span class=\"token comment\"># 调用config接口配置要生成的RKNN模型</span>\n    <span class=\"token comment\"># 调用config接口设置模型的预处理、量化方法等参数</span>\n    rknn<span class=\"token punctuation\">.</span>config<span class=\"token punctuation\">(</span>\n        quantized_dtype <span class=\"token operator\">=</span> <span class=\"token string\">\"asymmetric_quantized-8\"</span><span class=\"token punctuation\">,</span>     <span class=\"token comment\"># 表示默认为8位非对称量化。quantized_dtype表示量化类型   通用的模型权重和激活值都是float32类型的，会占据4个字节，而经过8位的非对称量化之后，权重和激活值量化为int8类型，只占1个字节</span>\n        quantized_algorithm <span class=\"token operator\">=</span> <span class=\"token string\">\"normal\"</span><span class=\"token punctuation\">,</span>                   <span class=\"token comment\"># quantized_algorithm表示量化的算法，目前支持norm,mmse,kl</span>\n        quantized_method <span class=\"token operator\">=</span> <span class=\"token string\">\"channel\"</span><span class=\"token punctuation\">,</span>                   <span class=\"token comment\"># quantized_method表示量化方式,总的有channel（通道级量化）和layer（层级量化）两种，channel的精度要要高一些，默认为channel</span>\n        quant_img_RGB2BGR <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>                      <span class=\"token comment\"># 表示在做量化时，是否做RGB2BGR的转换。此参数只会应用到量化阶段，并不会嵌入到RKNN模型中。</span>\n        target_platform <span class=\"token operator\">=</span> <span class=\"token string\">\"rk3588\"</span><span class=\"token punctuation\">,</span>                     <span class=\"token comment\"># target_platform表示生成的RKNN模型要运行在哪个RKNPU平台上。通常有rk3588,rk3566,rv1126等</span>\n        <span class=\"token comment\"># target_platform=\"rv1126\",</span>\n        float_dtype <span class=\"token operator\">=</span> <span class=\"token string\">\"float16\"</span><span class=\"token punctuation\">,</span>                        <span class=\"token comment\"># 表示RKNN模型的浮点数的类型，目前只支持float16的格式。如果不进行量化操作，则会将原始的float32格式默认转为float16格式。</span>\n        optimization_level <span class=\"token operator\">=</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>                         <span class=\"token comment\"># 表示优化等级，默认为3级，表示打开全部优化选项。如果设置为0则表示关闭所有优化选项。1，2代表中间值，表示打开部分优化选项。会对最后的精度值产生影响</span>\n        custom_string <span class=\"token operator\">=</span> <span class=\"token string\">\"this is my rknn model!\"</span><span class=\"token punctuation\">,</span>       <span class=\"token comment\"># 表示向RKNN模型中添加的自定义字符串信息，可以在CAPI中通过查询接口，查询到添加的自定义字符串信息</span>\n        remove_weight <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>                          <span class=\"token comment\"># 表示生成一个去除权重的从模型，可以使用CAPI与另一个完整的模型共享权重，从而减小内存的消耗 一般用在rv109和rv106上</span>\n        compress_weight <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>                        <span class=\"token comment\"># 压缩权重，可以减少模型的体积</span>\n        inputs_yuv_fmt <span class=\"token operator\">=</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span>                          <span class=\"token comment\"># 表示RKNN模型输入数据的yuv格式</span>\n        single_core_mode <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>                       <span class=\"token comment\"># 表示构建的RKNN模型运行在核心模式，只适用于RK3588</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 添加load_xxx接口，进行常用深度学习模型的导入           将深度学习模型导入</span>\n    rknn<span class=\"token punctuation\">.</span>load_onnx<span class=\"token punctuation\">(</span>\n        model <span class=\"token operator\">=</span> <span class=\"token string\">\"./UNet.onnx\"</span><span class=\"token punctuation\">,</span>            <span class=\"token comment\"># model表示加载模型的地址</span>\n        input_size_list <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span><span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>                            <span class=\"token comment\"># 表示模型输入节点对应图片的尺寸和通道数</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 使用build接口来构建RKNN模型</span>\n    rknn<span class=\"token punctuation\">.</span>build<span class=\"token punctuation\">(</span>\n        do_quantization<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 调用export_rknn接口导出RKNN模型</span>\n    rknn<span class=\"token punctuation\">.</span>export_rknn<span class=\"token punctuation\">(</span>\n        export_path<span class=\"token operator\">=</span><span class=\"token string\">\"model_bce.rknn\"</span>              <span class=\"token comment\"># 表示导出的RKNN模型路径和名称</span>\n    <span class=\"token punctuation\">)</span>\n    rknn<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 释放</span>\n</code></pre></div>\n<p>这里input_size_list按照自己模型情况改变,需要注意的是mean_values和std_values、rknn的预处理过程、模型量化过程并非必须,可以省略</p>\n<h3 id=\"最后部署到开发板\" style=\"position:relative;\">最后,部署到开发板<a href=\"#%E6%9C%80%E5%90%8E%E9%83%A8%E7%BD%B2%E5%88%B0%E5%BC%80%E5%8F%91%E6%9D%BF\" aria-label=\"最后部署到开发板 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p>将rknn模型发送到开发板上后就可以尝试运行了\n重点:</p>\n<ul>\n<li>更新驱动</li>\n<li>注意pytorch相关代码不能运行,能改成numpy尽量改\n极简版(不保证能运行,仅用以展示流程):</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> rknnlite<span class=\"token punctuation\">.</span>api <span class=\"token keyword\">import</span> RKNNLite\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    rknn <span class=\"token operator\">=</span> RKNNLite<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    rknn<span class=\"token punctuation\">.</span>load_rknn<span class=\"token punctuation\">(</span>path<span class=\"token operator\">=</span><span class=\"token string\">\"resnet18.rknn\"</span><span class=\"token punctuation\">)</span>\n    rknn<span class=\"token punctuation\">.</span>init_runtime<span class=\"token punctuation\">(</span>\n        core_mask <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">)</span>\n    output <span class=\"token operator\">=</span> rknn<span class=\"token punctuation\">.</span>inference<span class=\"token punctuation\">(</span>\n        inputs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>img<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        data_format<span class=\"token operator\">=</span><span class=\"token boolean\">None</span>\n    <span class=\"token punctuation\">)</span>\n    rknn<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>完整版:</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> rknnlite<span class=\"token punctuation\">.</span>api <span class=\"token keyword\">import</span> RKNNLite\n<span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">from</span> matplotlib <span class=\"token keyword\">import</span> pyplot <span class=\"token keyword\">as</span> plt\n<span class=\"token keyword\">import</span> math\n<span class=\"token keyword\">import</span> time\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">imsshow</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">,</span> titles<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> num_col<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> dpi<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> cmap<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">,</span> is_colorbar<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">,</span> is_ticks<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">'''\n    assume imgs's shape is (Nslice, Nx, Ny)\n    '''</span>\n    num_imgs <span class=\"token operator\">=</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">)</span>\n    num_row <span class=\"token operator\">=</span> math<span class=\"token punctuation\">.</span>ceil<span class=\"token punctuation\">(</span>num_imgs <span class=\"token operator\">/</span> num_col<span class=\"token punctuation\">)</span>\n    fig_width <span class=\"token operator\">=</span> num_col <span class=\"token operator\">*</span> <span class=\"token number\">3</span>\n    <span class=\"token keyword\">if</span> is_colorbar<span class=\"token punctuation\">:</span>\n        fig_width <span class=\"token operator\">+=</span> num_col <span class=\"token operator\">*</span> <span class=\"token number\">1.5</span>\n    fig_height <span class=\"token operator\">=</span> num_row <span class=\"token operator\">*</span> <span class=\"token number\">3</span>\n    fig <span class=\"token operator\">=</span> plt<span class=\"token punctuation\">.</span>figure<span class=\"token punctuation\">(</span>dpi<span class=\"token operator\">=</span>dpi<span class=\"token punctuation\">,</span> figsize<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>fig_width<span class=\"token punctuation\">,</span> fig_height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>num_imgs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        ax <span class=\"token operator\">=</span> plt<span class=\"token punctuation\">.</span>subplot<span class=\"token punctuation\">(</span>num_row<span class=\"token punctuation\">,</span> num_col<span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        im <span class=\"token operator\">=</span> ax<span class=\"token punctuation\">.</span>imshow<span class=\"token punctuation\">(</span>imgs<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> cmap<span class=\"token operator\">=</span>cmap<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> titles<span class=\"token punctuation\">:</span>\n            plt<span class=\"token punctuation\">.</span>title<span class=\"token punctuation\">(</span>titles<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> is_colorbar<span class=\"token punctuation\">:</span>\n            cax <span class=\"token operator\">=</span> fig<span class=\"token punctuation\">.</span>add_axes<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>ax<span class=\"token punctuation\">.</span>get_position<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>x1 <span class=\"token operator\">+</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> ax<span class=\"token punctuation\">.</span>get_position<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>y0<span class=\"token punctuation\">,</span> <span class=\"token number\">0.01</span><span class=\"token punctuation\">,</span> ax<span class=\"token punctuation\">.</span>get_position<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            plt<span class=\"token punctuation\">.</span>colorbar<span class=\"token punctuation\">(</span>im<span class=\"token punctuation\">,</span> cax<span class=\"token operator\">=</span>cax<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> is_ticks<span class=\"token punctuation\">:</span>\n            ax<span class=\"token punctuation\">.</span>set_xticks<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            ax<span class=\"token punctuation\">.</span>set_yticks<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    plt<span class=\"token punctuation\">.</span>show<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    plt<span class=\"token punctuation\">.</span>close<span class=\"token punctuation\">(</span><span class=\"token string\">'all'</span><span class=\"token punctuation\">)</span>\n\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">process_data</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    path <span class=\"token operator\">=</span> <span class=\"token string\">\"./cine_seg.npz\"</span>\n    dataset <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>load<span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> allow_pickle<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    files <span class=\"token operator\">=</span> dataset<span class=\"token punctuation\">.</span>files\n    inputs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    labels <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">for</span> <span class=\"token builtin\">file</span> <span class=\"token keyword\">in</span> files<span class=\"token punctuation\">:</span>\n        inputs<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">[</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        labels<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">[</span><span class=\"token builtin\">file</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    inputs <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">)</span>\n    labels <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>labels<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> inputs<span class=\"token punctuation\">,</span> labels\n\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">\"__main__\"</span><span class=\"token punctuation\">:</span>\n    rknn <span class=\"token operator\">=</span> RKNNLite<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    inputs<span class=\"token punctuation\">,</span> labels <span class=\"token operator\">=</span> process_data<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">)</span>\n    inputs<span class=\"token punctuation\">.</span>resize<span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> inputs<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> inputs<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    labels<span class=\"token punctuation\">.</span>resize<span class=\"token punctuation\">(</span>labels<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n\n    <span class=\"token comment\"># 使用load_rknn接口直接加载RKNN模型</span>\n    rknn<span class=\"token punctuation\">.</span>load_rknn<span class=\"token punctuation\">(</span>path<span class=\"token operator\">=</span><span class=\"token string\">\"model_bce.rknn\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># 调用init_runtime接口初始化运行时环境</span>\n    rknn<span class=\"token punctuation\">.</span>init_runtime<span class=\"token punctuation\">(</span>\n        core_mask <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># core_mask表示NPU的调度模式，设置为0时表示自由调度，设置为1，2，4时分别表示调度某个单核心，设置为3时表示同时调度0和1两个核心，设置为7时表示1，2，4三个核心同时调度</span>\n        <span class=\"token comment\"># targt = \"rk3588\"</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 使用Opencv读取图片</span>\n    input1 <span class=\"token operator\">=</span> inputs<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token number\">33</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\"># 调用inference接口进行推理测试</span>\n    start_time <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    output <span class=\"token operator\">=</span> rknn<span class=\"token punctuation\">.</span>inference<span class=\"token punctuation\">(</span>\n        inputs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>input1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        data_format<span class=\"token operator\">=</span><span class=\"token boolean\">None</span>\n    <span class=\"token punctuation\">)</span>\n    end_time <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\">#下面是从独热编码到图像的逻辑,可以不看</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Execution time: {} seconds\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>end_time <span class=\"token operator\">-</span> start_time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    image<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span>\n    pred_seg_probs <span class=\"token operator\">=</span> image<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n    pred_seg_mask <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>pred_seg_probs <span class=\"token operator\">></span> <span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> pred_seg_probs<span class=\"token punctuation\">,</span> np<span class=\"token punctuation\">.</span>zeros_like<span class=\"token punctuation\">(</span>pred_seg_probs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    pred_seg_mask_argmax <span class=\"token operator\">=</span> <span class=\"token number\">3</span> <span class=\"token operator\">-</span> np<span class=\"token punctuation\">.</span>argmax<span class=\"token punctuation\">(</span>pred_seg_mask<span class=\"token punctuation\">,</span> axis<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> keepdims<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n    mask <span class=\"token operator\">=</span> pred_seg_mask <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n    mask <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span><span class=\"token builtin\">sum</span><span class=\"token punctuation\">(</span>mask<span class=\"token punctuation\">,</span> axis<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> keepdims<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    mask <span class=\"token operator\">=</span> mask <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n    pred_seg_mask <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">(</span>mask<span class=\"token punctuation\">,</span> pred_seg_mask_argmax<span class=\"token punctuation\">,</span> np<span class=\"token punctuation\">.</span>zeros_like<span class=\"token punctuation\">(</span>pred_seg_mask_argmax<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    pred_seg_probs <span class=\"token operator\">=</span> pred_seg_mask\n    image <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># seg_gt = self.to_numpy(seg_gt[1, 0, :, :])</span>\n    pred_seg_mask <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span>pred_seg_mask<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    set_gt <span class=\"token operator\">=</span> labels<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n    dpi<span class=\"token operator\">=</span><span class=\"token number\">100</span>\n    imsshow<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>pred_seg_mask<span class=\"token punctuation\">,</span> set_gt<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    titles<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Image'</span><span class=\"token punctuation\">,</span>\n                            <span class=\"token string-interpolation\"><span class=\"token string\">f\"Prediction\"</span></span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n                    num_col<span class=\"token operator\">=</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n                    dpi<span class=\"token operator\">=</span>dpi<span class=\"token punctuation\">,</span>\n                    is_colorbar<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n    rknn<span class=\"token punctuation\">.</span>release<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"最后结果展示\" style=\"position:relative;\">最后结果展示<a href=\"#%E6%9C%80%E5%90%8E%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA\" aria-label=\"最后结果展示 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f55913d85f4d9f89b36b13c9d33db38c/23725/img.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.35443037974683%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAIAAACgpqunAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVElEQVR42m2TS2sTYRSGTyMiCNJu2gpS0T8gSSlN4lQqhmhzcdo0k6SmSZMKqZeF2EBdqFEUxK1/QHHhBUqQNEgQayLRhFgqVrAbdy22lCTNZSaXuX0z4yTGNB39OMPAe+Y55x14P5BESVGiQJOldZ4T/mmhcuEryyBJaikgPzzL/y0OsSJdL/zaeSciCXF8RwuxdG1jO9zExD1YcVhU/ZnNCEjZQAK3vhOXZENtWB65uryWin5JRtLR57H00kp8KfkmEZG3fU/+SC2tJMKfI8/efgynPkUzL9+/5upcY5LQhKliZXxgZgiMmMqCwRgGFg0YZ/wLTI3xqq8PgqGpm7AuyyAYnf6bDEU3flkQm3CpMnV8bhTwsyqHDlzGLkIPuNcbYutMQB0cAavhgEMPToOKGIHxCdcCtUvuh08EtDDuG8JfPR0xdduHAfe47zVgzbwOrPgx+5PHBmv/pA4uTjpvKzdfOjmHAW7xX3mw6DIdtuvkQY77DXgweBosptGroRd+U69T/oaw3aHJegdcrNgHLuvBpD3kOqWakv0PgdmL32XqtF99YxjOYwedanCf6ZrQgtl24RZV7LBdLVcDmqC1x0P0+hx9XvvR2bGe6WvORyzNzJ8LmY+4iT4f0e+RdXP39KztIVtj9mD5Re5SxWyplCdLOZLapbY2sokPa5IgyqZaep4s58ncdiESybQT8v+QVCt0JrkuCoJC51g+HvvWXtuCBV5oVTPPVKGaiq3KMRJQQ/nTEpHIVJnlxbQS3ldyDDmU3cohHikvDBJ3NrNih+3fDUhxHUYCCqgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"img.png\"\n        title=\"\"\n        src=\"/static/f55913d85f4d9f89b36b13c9d33db38c/f058b/img.png\"\n        srcset=\"/static/f55913d85f4d9f89b36b13c9d33db38c/c26ae/img.png 158w,\n/static/f55913d85f4d9f89b36b13c9d33db38c/6bdcf/img.png 315w,\n/static/f55913d85f4d9f89b36b13c9d33db38c/f058b/img.png 630w,\n/static/f55913d85f4d9f89b36b13c9d33db38c/40601/img.png 945w,\n/static/f55913d85f4d9f89b36b13c9d33db38c/23725/img.png 1105w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"参考\" style=\"position:relative;\">参考:<a href=\"#%E5%8F%82%E8%80%83\" aria-label=\"参考 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<ul>\n<li>模型部署——使用rknn-toolkit将Pytorch模型转为RKNN模型（详细图文教程）: <a href=\"https://blog.csdn.net/qq_40280673/article/details/136229500\">https://blog.csdn.net/qq_40280673/article/details/136229500</a></li>\n<li>RKNN Toolkit2介绍: <a href=\"https://doc.embedfire.com/linux/rk356x/Ai/zh/latest/lubancat_ai/env/toolkit2.html\">https://doc.embedfire.com/linux/rk356x/Ai/zh/latest/lubancat_ai/env/toolkit2.html</a></li>\n</ul>","tableOfContents":"<ul>\n<li>\n<p><a href=\"#pipeline%E6%90%AD%E5%BB%BA\">pipeline搭建</a></p>\n<ul>\n<li><a href=\"#%E8%A7%82%E5%AF%9F%E5%88%B0%E6%89%80%E6%8F%90%E4%BE%9B%E7%9A%84ground-truth%E4%B8%BA%E7%81%B0%E5%BA%A6%E5%9B%BE%E5%83%8F%E9%A6%96%E5%85%88%E8%A6%81%E5%81%9A%E7%9A%84%E4%BE%BF%E6%98%AF%E7%94%B1%E7%81%B0%E5%BA%A6%E5%9B%BE%E5%83%8F%E8%BD%AC%E4%B8%BA%E7%8B%AC%E7%83%AD%E7%BC%96%E7%A0%81\">观察到所提供的ground truth为灰度图像,首先要做的便是由灰度图像转为独热编码</a></li>\n<li><a href=\"#%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8unet%E8%AE%AD%E7%BB%83unet%E4%B8%8Epytorch%E6%89%80%E6%8F%90%E4%BE%9Bunet%E6%BA%90%E7%A0%81%E5%9F%BA%E6%9C%AC%E4%B8%80%E8%87%B4%E5%9C%A8%E6%AD%A4%E7%95%A5%E8%BF%87\">然后,使用UNet训练(UNet与pytorch所提供UNet源码基本一致,在此略过)</a></li>\n<li><a href=\"#%E6%9C%80%E5%90%8E%E4%B8%8D%E8%A6%81%E5%BF%98%E4%BA%86%E4%BF%9D%E5%AD%98%E4%B8%BApth%E6%A8%A1%E5%9E%8Bonnx%E6%A8%A1%E5%9E%8B%E6%9B%B4%E4%BD%B3\">最后,不要忘了保存为pth模型(onnx模型更佳)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#rk3588%E6%9D%BF%E7%AB%AF%E6%8E%A8%E7%90%86%E9%83%A8%E7%BD%B2\">rk3588板端推理部署</a></p>\n<ul>\n<li><a href=\"#%E5%A6%82%E6%9E%9C%E5%89%8D%E9%9D%A2%E4%BF%9D%E5%AD%98%E7%9A%84%E6%A8%A1%E5%9E%8B%E4%B8%BApth%E6%A8%A1%E5%9E%8B%E9%82%A3%E4%B9%88%E9%A6%96%E5%85%88%E9%9C%80%E8%A6%81%E8%BD%AC%E6%8D%A2%E4%B8%BAonnx%E6%A8%A1%E5%9E%8B\">如果前面保存的模型为pth模型,那么首先需要转换为onnx模型</a></li>\n<li><a href=\"#%E5%86%8D%E5%B0%86onnx%E6%A8%A1%E5%9E%8B%E8%BD%AC%E5%8C%96%E4%B8%BArknn%E6%A8%A1%E5%9E%8B\">再将onnx模型转化为rknn模型</a></li>\n<li><a href=\"#%E6%9C%80%E5%90%8E%E9%83%A8%E7%BD%B2%E5%88%B0%E5%BC%80%E5%8F%91%E6%9D%BF\">最后,部署到开发板</a></li>\n<li><a href=\"#%E6%9C%80%E5%90%8E%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA\">最后结果展示</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%E5%8F%82%E8%80%83\">参考:</a></p>\n</li>\n</ul>","headings":[{"value":"pipeline搭建","depth":2},{"value":"观察到所提供的ground truth为灰度图像,首先要做的便是由灰度图像转为独热编码","depth":3},{"value":"然后,使用UNet训练(UNet与pytorch所提供UNet源码基本一致,在此略过)","depth":3},{"value":"最后,不要忘了保存为pth模型(onnx模型更佳)","depth":3},{"value":"rk3588板端推理部署","depth":2},{"value":"如果前面保存的模型为pth模型,那么首先需要转换为onnx模型","depth":3},{"value":"再将onnx模型转化为rknn模型","depth":3},{"value":"最后,部署到开发板","depth":3},{"value":"最后结果展示","depth":3},{"value":"参考:","depth":2}],"frontmatter":{"title":"从医学图像分割pipeline搭建到rk3588板端推理部署","date":"April 22, 2024","description":"搭建医学图像分割pipeline并部署到rk3588板端"}},"previous":{"fields":{"slug":"/IMU/"},"frontmatter":{"title":"IMU项目总结"}},"next":{"fields":{"slug":"/MX6ULL-dw1000/"},"frontmatter":{"title":"正点原子I.MX6ULL mini适配xueliu dw1000驱动"}}},"pageContext":{"id":"a6873150-1878-5adc-9253-c43f8616d630","previousPostId":"6f56132e-fad4-5016-b290-92ea913e71c2","nextPostId":"c496b3a2-1cb2-56e5-9bf1-824226faf695"}},"staticQueryHashes":["230163734","2841359383"],"slicesMap":{}}